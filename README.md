# dwm-screen-shot
## Inject shellcode into dwm.exe for DXGI screenshots
* Forked from [here](https://github.com/lainswork/dwm-screen-shot)
> The code in the imgui display part is a bit ugly....
## Features

* ~~Compatible with most Windows 10/11 systems~~
  * Doesn't seem to work on recent Windows 11 versions
    * [Mirillis Action](https://mirillis.com/en/products/action.html) (paid, watermarked demo available) is also capable of grabbing DWM screenshots, try that if this doesn't work
* Purposes
  * Bypass various anti-screenshot techniques
    * SetWindowDisplayAffinity
    * Function hooks (BitBlt, PrintWindow etc.)
    * DRM (Widevine, PlayReady)
      * Note that the whole screen will be scrambled/encrypted if HDCP (2.2?) is being used.
  * Understand how multiplane overlay (MPO) and fullscreen optimization (FSO) works
    * Figure out what are being rendered in MPO (they won't appear in this program's screenshot)

## Changes from the original repository
* Translated the whole program to English.
* Automatically save the taken screenshot to file.
* Automatically run as administrator.
* Automatically take screenshot on launch.
* Automatically exit after taking screenshot.
* Only download symbol once - try deleting dxgi.pdb if it's not working after update.

## Build
* From console (original repo's method):
```shell
// Make sure u have installed Visual Studio 2019 or later version
// Open PowerShell and enter a folder prepared for the project, enter the following commands in turn, Enter the following commands in PowerShell

> git clone https://github.com/lainswork/dwm-screen-shot.git

> cd dwm-screen-shot

> git submodule update --init --recursive

> cd ./build

> devenv dwm-screen-shot.sln /build "Debug|x64" /Project dwm-screen-shot

> cd ../bin/x64/Debug

> .\dwm-screen-shot

````
Or just build it with the VS GUI. (Used 2022)

## Demo
https://user-images.githubusercontent.com/46841563/159519403-597fb25b-c353-46b6-98a6-90b68e83b263.mp4

### Below is just a google translated original readme
## Notice
##### You may find that there is a payload.hpp in the source code, this is the shellcode generated by the main code of the screenshot
- Please see [shellcode-factory](https://github.com/lainswork/shellcode-factory)
- in shellcode-factory/shellcode-payload/dwm-screen-shot-demo.cpp you will see how it is written
## Dependencies
- [shellcode-factory](https://github.com/lainswork/shellcode-factory)

- [imgui](https://github.com/ocornut/imgui)
  - Please use my fork: [imgui](https://github.com/lainswork/imgui)
- [raw_pdb](https://github.com/MolecularMatters/raw_pdb)
  - Please use my fork: [raw_pdb](https://github.com/lainswork/raw_pdb)
- DirectXTK

## Knowledge
> Direct3D(...Dx9 Dx10 Dx11 Dx12...) and DXGI
- Direct3D is a low-level drawing API (application programming interface) that allows us to draw 3D worlds through 3D hardware acceleration. Essentially, Direct3D provides a set of software interfaces through which we can control the graphics hardware.
[In the past, the graphics subsystems were all owned by D3D, and as a result, D3D8/D3D9 had a set of codes to manage the swap chain. In Vista+, there are more and more graphics APIs, D3D9/D3D10/D3D11/D3D12, a set of swap chain is too meaningless. Therefore, all APIs can be refactored to share a swap chain code, which is placed in DXGI. In addition, things like full-screening of windows are also owned by DXGI, and you can think that the part of the screen output is owned by DXGI. ](https://www.zhihu.com/question/36501678/answer/67786884)

> DWM
- Desktop Window Manager (dwm.exe) is an integral part of the window manager. [Later DXGI added some low-level functions to deal with DWM, such as copying mixed screens, device rotation, cross-screen windows](https ://www.zhihu.com/question/36501678/answer/67786884)

> VEH hook
- ...to be continued

> Code injection under multi-threading
- ...to be continued
